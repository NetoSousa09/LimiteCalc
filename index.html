<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;color:#333}
    .container{max-width:500px;margin:0 auto;background:white;min-height:100vh;padding-bottom:20px}
    header{background:#00bd56;color:white;text-align:center;padding:20px;font-size:28px}
    #circle{width:300px;height:300px;margin:30px auto;border-radius:50%;border:25px solid #4CAF50;position:relative;background:#fff;box-shadow:0 0 20px rgba(0,0,0,.1)}
    #progress{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;font-weight:bold;color:#00bd56}
    .btn{padding:18px 30px;margin:15px;font-size:20px;border:none;border-radius:15px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .btn-primary{background:#00bd56;color:white}
    .btn-capture{background:#007bff;color:white}
    .btn-whatsapp{background:#25D366;color:white}
    .item{padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-size:18px}
    .delete{color:red;font-size:24px;cursor:pointer}
    #tecladoModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);justify-content:center;align-items:center;z-index:999}
    .teclado-container{background:white;border-radius:20px;padding:30px;width:90%;max-width:420px;text-align:center}
    .display-preco{font-size:60px;font-weight:bold;margin:30px 0;color:#00bd56}
    .teclado{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    .teclado button{font-size:40px;padding:25px;border-radius:20px;background:#f0f0f0;border:none;box-shadow:0 6px 15px rgba(0,0,0,.1)}
    .teclado .ok{background:#00bd56;color:white;grid-column:1/4;font-size:32px}
    .teclado .apagar{background:#ff4444;color:white}
    #msgErro{background:#fff3cd;color:#856404;padding:15px;border-radius:10px;margin-bottom:20px;font-size:18px}
    #botoesFinais{display:none;justify-content:center;gap:30px;margin:30px;flex-wrap:wrap}
    input#nomeProduto{width:100%;padding:18px;margin-top:25px;font-size:20px;border-radius:15px;border:2px solid #ddd}
    #limitDiv{text-align:center;padding:20px}
    #limitDiv input{padding:15px;font-size:22px;width:180px;border-radius:12px;border:2px solid #ddd;margin-right:10px}
  </style>
  <!-- Tesseract versão leve que não estoura memória -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/vfs_fonts.js"></script>
</head>
<body>
  <div class="container">
    <header>LimitCalc</header>
    <div id="limitDiv">
      <input type="number" id="limite" placeholder="Seu limite R$" step="0.01">
      <button class="btn btn-primary" onclick="definirLimite()">Definir</button>
    </div>
    <div id="circle"><div id="progress">R$ 0,00</div></div>
    <div style="text-align:center">
      <button class="btn btn-capture" onclick="iniciarCaptura()">Capturar Etiqueta</button>
      <button class="btn btn-primary" onclick="abrirTeclado()">Adicionar Manual</button>
    </div>
    <div id="listaItens" style="margin:20px;"></div>
    <div id="botoesFinais">
      <button class="btn btn-primary" onclick="baixarPDF()">Baixar PDF</button>
      <button class="btn btn-whatsapp" onclick="compartilharWhats()">WhatsApp</button>
    </div>
  </div>

  <div id="tecladoModal">
    <div class="teclado-container">
      <div id="msgErro" style="display:none"></div>
      <div class="display-preco">R$ <span id="reais">0</span>,<span id="centavos">00</span></div>
      <div class="teclado">
        <button onclick="digito(1)">1</button><button onclick="digito(2)">2</button><button onclick="digito(3)">3</button>
        <button onclick="digito(4)">4</button><button onclick="digito(5)">5</button><button onclick="digito(6)">6</button>
        <button onclick="digito(7)">7</button><button onclick="digito(8)">8</button><button onclick="digito(9)">9</button>
        <button onclick="apagar()" class="apagar">Apagar</button><button onclick="digito(0)">0</button>
        <button onclick="confirmar()" class="ok">ADICIONAR</button>
      </div>
      <input type="text" id="nomeProduto" placeholder="Nome do produto (opcional)">
    </div>
  </div>

  <script>
    let limite=0,total=0,itens=[],valorCentavos=0;
    if(localStorage.limitCalc){const d=JSON.parse(localStorage.limitCalc);limite=d.limite||0;total=d.total||0;itens=d.itens||[];atualizarTudo()}
    function definirLimite(){limite=parseFloat(document.getElementById('limite').value)||0;salvar();atualizarTudo()}
    function atualizarTudo(){
      document.getElementById('progress').innerText=`R$ ${total.toFixed(2).replace('.',',')}`;
      const perc=limite>0?total/limite*100:0;
      let cor='#4CAF50';if(perc>=90)cor='#f44336';else if(perc>=70)cor='#ff9800';
      document.querySelector('#circle').style.borderColor=cor;
      document.getElementById('botoesFinais').style.display=itens.length>0?'flex':'none';
      renderLista();salvar();
    }
    function renderLista(){document.getElementById('listaItens').innerHTML=itens.map((i,idx)=>`<div class="item"><span>${i.nome} - R$ ${i.preco.toFixed(2).replace('.',',')}</span><span class="delete" onclick="remover(${idx})">Excluir</span></div>`).join('')}
    function adicionar(nome='',preco=0){if(preco<=0)return;nome=nome||document.getElementById('nomeProduto').value.trim()||`Item R$ ${preco.toFixed(2)}`;itens.push({nome,preco});total+=preco;fecharTeclado();atualizarTudo()}
    function remover(idx){total-=itens[idx].preco;itens.splice(idx,1);atualizarTudo()}
    function salvar(){localStorage.limitCalc=JSON.stringify({limite,total,itens})}
    function abrirTeclado(m=''){valorCentavos=0;atualizarDisplay();document.getElementById('nomeProduto').value='';if(m){document.getElementById('msgErro').innerHTML=m;document.getElementById('msgErro').style.display='block'}else document.getElementById('msgErro').style.display='none';document.getElementById('tecladoModal').style.display='flex';setTimeout(()=>document.getElementById('nomeProduto').focus(),300)}
    function fecharTeclado(){document.getElementById('tecladoModal').style.display='none'}
    function digito(n){if(valorCentavos<1000000)valorCentavos=valorCentavos*10+n;atualizarDisplay()}
    function apagar(){valorCentavos=Math.floor(valorCentavos/10);atualizarDisplay()}
    function atualizarDisplay(){const reais=Math.floor(valorCentavos/100).toLocaleString('pt-BR');const centavos=(valorCentavos%100).toString().padStart(2,'0');document.getElementById('reais').innerText=reais;document.getElementById('centavos').innerText=centavos}
    function confirmar(){const preco=valorCentavos/100;if(preco<=0)return alert('Digite um valor!');adicionar('',preco)}

    // CAPTURA 100% IMUNE A MEMÓRIA + REGEX PERFEITA
    function iniciarCaptura(){
      const input=document.createElement('input');input.type='file';input.accept='image/*';input.capture='environment';
      input.onchange=async e=>{
        const file=e.target.files[0];if(!file)return;
        const img=new Image();
        img.onload=async()=>{
          const canvas=document.createElement('canvas');
          const ctx=canvas.getContext('2d');
          canvas.width=600;canvas.height=600*(img.height/img.width);
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          const dataUrl=canvas.toDataURL('image/jpeg',0.5); // 50% qualidade = nunca estoura memória
          try{
            const worker=Tesseract.createWorker({workerPath:'https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/worker.min.js',corePath:'https://cdn.jsdelivr.net/npm/tesseract.js-core@4.0.2/tesseract-core.wasm.js'});
            await worker.load();
            await worker.loadLanguage('por');
            await worker.initialize('por',{tessedit_pageseg_mode:'6'});
            const {data:{text}}=await worker.recognize(dataUrl);
            await worker.terminate();
            const preco=extrairPreco(text);
            const nome=extrairNome(text);
            if(preco && confirm(`ENCONTRADO!\n\n${nome}\nR$ ${preco.toFixed(2).replace('.',',')}\n\nAdicionar?`)){adicionar(nome,preco)}
            else abrirTeclado('Digite o preço manualmente');
          }catch(err){abrirTeclado('Erro de processamento. Digite manualmente')}
        }
        img.src=URL.createObjectURL(file);
      }
      input.click();
    }

    function extrairPreco(t){
      const regex=/R?\s*\$?\s*([\d.,]+\d{2})/g;
      const matches=[...t.matchAll(regex)].map(m=>m[1].replace(/\./g,'').replace(',','.'));
      if(matches.length===0)return null;
      const valores=matches.map(parseFloat).filter(v=>!isNaN(v));
      return valores.length>0?Math.max(...valores):null;
    }

    function extrairNome(t){
      const linhas=t.split('\n').map(l=>l.trim()).filter(l=>l.length>3 && !l.match(/R?\s*\$?\s*\d/));
      return linhas[0]||'Produto';
    }

    function baixarPDF(){
      const doc={pageSize:'A6',pageMargins:[15,20,15,20],content:[{text:'LimitCalc',style:'header'},{text:new Date().toLocaleString('pt-BR')},{table:{widths:['*','auto'],body:[[{text:'Produto',bold:true},{text:'Valor',bold:true}],...itens.map(i=>[i.nome,`R$ ${i.preco.toFixed(2).replace('.',',')}`]),[{text:'TOTAL',bold:true},{text:`R$ ${total.toFixed(2).replace('.',',')}`,bold:true}]]}}],styles:{header:{fontSize:24,bold:true,alignment:'center',color:'#00bd56'}}};
      pdfMake.createPdf(doc).download(`LimitCalc_${new Date().toLocaleDateString('pt-BR')}.pdf`);
    }

    function compartilharWhats(){
      const doc={/* mesmo conteúdo do PDF */};
      pdfMake.createPdf(doc).getBlob(blob=>{
        const file=new File([blob],"LimitCalc.pdf",{type:"application/pdf"});
        if(navigator.share&&navigator.canShare({files:[file]}))navigator.share({files:[file],title:'Minha compra',text:'Olha quanto gastei!'});
        else alert('Use o botão Baixar PDF');
      });
    }

    document.getElementById('tecladoModal').onclick=e=>{if(e.target===document.getElementById('tecladoModal'))fecharTeclado()}
  </script>
</body>
</html>
