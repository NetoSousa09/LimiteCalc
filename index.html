<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; color: #333; }
    .container { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 20px; }
    header { background: #00bd56; color: white; text-align: center; padding: 30px; font-size: 40px; font-weight: bold; }
    header span { font-size: 60px; color: #000; } /* Carrinho preto grande */
    #circle { width: 300px; height: 300px; margin: 30px auto; border-radius: 50%; border: 25px solid #4CAF50; position: relative; background: #fff; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    #progress { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 70px; font-weight: bold; color: #00bd56; }
    .btn { padding: 18px 30px; margin: 15px; font-size: 20px; border: none; border-radius: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .btn-primary { background: #00bd56; color: white; }
    .btn-capture { background: #007bff; color: white; }
    .btn-whatsapp { background: #25D366; color: white; }
    .item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 18px; }
    .delete { color: red; font-size: 24px; cursor: pointer; }
    #tecladoModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 999; }
    .teclado-container { background: white; border-radius: 20px; padding: 30px; width: 90%; max-width: 420px; text-align: center; }
    .display-preco { font-size: 60px; font-weight: bold; margin: 30px 0; color: #00bd56; }
    .teclado { display: grid; grid-template-columns: repeat(3,1fr); gap: 20px; }
    .teclado button { font-size: 40px; padding: 25px; border-radius: 20px; background: #f0f0f0; border: none; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
    .teclado .ok { background: #00bd56; color: white; grid-column: 1 / 4; font-size: 32px; }
    .teclado .apagar { background: #ff4444; color: white; }
    #msgErro { background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 18px; }
    #botoesFinais { display: none; justify-content: center; gap: 30px; margin: 30px; flex-wrap: wrap; }
    input#nomeProduto { width: 100%; padding: 18px; margin-top: 25px; font-size: 20px; border-radius: 15px; border: 2px solid #ddd; }
    #limitDiv { text-align: center; padding: 20px; }
    #limitDiv input { padding: 15px; font-size: 22px; width: 180px; border-radius: 12px; border: 2px solid #ddd; margin-right: 10px; }
    #listaModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; justify-content: center; align-items: center; padding: 20px; }
    .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 90%; max-height: 90%; overflow-y: auto; text-align: center; }
    .modal-content h2 { font-size: 36px; color: #00bd56; margin: 10px; }
    .lista-item { font-size: 22px; padding: 12px 0; border-bottom: 1px solid #eee; }
    .total { font-size: 30px; font-weight: bold; color: #00bd56; margin: 25px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/vfs_fonts.js"></script>
</head>
<body>
  <div class="container">
    <header>LimitCalc <span>üõí</span></header>
    <div id="limitDiv">
      <input type="number" id="limite" placeholder="Seu limite R$" step="0.01">
      <button class="btn btn-primary" onclick="definirLimite()">Definir Limite</button>
    </div>
    <div id="circle"><div id="progress">R$ 0,00</div></div>
    <div style="text-align:center">
      <button class="btn btn-capture" onclick="iniciarCaptura()">üì∏ Capturar Etiqueta</button>
      <button class="btn btn-primary" onclick="abrirTeclado()">‚ûï Adicionar Manual</button>
    </div>
    <div id="listaItens" style="margin:20px;"></div>
    <div id="botoesFinais">
      <button class="btn btn-primary" onclick="abrirListaModal()">Visualizar Lista</button>
    </div>
  </div>

  <!-- Modal Teclado -->
  <div id="tecladoModal">
    <div class="teclado-container">
      <div id="msgErro" style="display:none"></div>
      <div class="display-preco">R$ <span id="reais">0</span>,<span id="centavos">00</span></div>
      <div class="teclado">
        <button onclick="digito(1)">1</button><button onclick="digito(2)">2</button><button onclick="digito(3)">3</button>
        <button onclick="digito(4)">4</button><button onclick="digito(5)">5</button><button onclick="digito(6)">6</button>
        <button onclick="digito(7)">7</button><button onclick="digito(8)">8</button><button onclick="digito(9)">9</button>
        <button onclick="apagar()" class="apagar">‚Üê</button><button onclick="digito(0)">0</button>
        <button onclick="confirmar()" class="ok">ADICIONAR</button>
      </div>
      <input type="text" id="nomeProduto" placeholder="Nome do produto (opcional)">
    </div>
  </div>

  <!-- Modal Lista -->
  <div id="listaModal">
    <div class="modal-content">
      <h2>LimitCalc</h2>
      <h3>Lista de Produtos</h3>
      <div id="listaModalItens"></div>
      <div class="total" id="totalModal"></div>
      <p style="font-size:18px;color:#666"><em>Data: <span id="dataAtual"></span></em></p>
      <button class="btn btn-primary" onclick="baixarPDF()">Salvar PDF</button>
      <button class="btn btn-whatsapp" onclick="compartilharWhats()">Compartilhar WhatsApp</button>
      <button class="btn" style="background:#ccc;color:#333" onclick="fecharListaModal()">Fechar</button>
    </div>
  </div>

  <script>
    let limite = 0, total = 0, itens = [], valorCentavos = 0;

    if (localStorage.getItem('limitCalc')) {
      const d = JSON.parse(localStorage.getItem('limitCalc'));
      limite = d.limite || 0; total = d.total || 0; itens = d.itens || [];
      atualizarTudo();
    }

    function definirLimite() {
      limite = parseFloat(document.getElementById('limite').value) || 0;
      salvar(); atualizarTudo();
    }

    function atualizarTudo() {
      document.getElementById('progress').innerText = `R$ ${total.toFixed(2).replace('.', ',')}`;
      const perc = limite > 0 ? total / limite * 100 : 0;
      let cor = '#4CAF50';
      if (perc >= 95) cor = '#f44336';
      else if (perc >= 50) cor = '#ff9800';
      document.querySelector('#circle').style.borderColor = cor;
      document.getElementById('botoesFinais').style.display = itens.length > 0 ? 'flex' : 'none';
      renderLista();
      salvar();
    }

    function renderLista() {
      document.getElementById('listaItens').innerHTML = itens.map((i, idx) => 
        `<div class="item"><span>${i.nome} - R$ ${i.preco.toFixed(2).replace('.', ',')}</span><span class="delete" onclick="remover(${idx})">‚úñ</span></div>`
      ).join('');
    }

    function adicionar(nome = '', preco = 0) {
      if (preco <= 0) return;
      nome = nome || document.getElementById('nomeProduto').value.trim() || `Item R$ ${preco.toFixed(2)}`;
      itens.push({ nome, preco });
      total += preco;
      fecharTeclado();
      atualizarTudo();
    }

    function remover(idx) {
      total -= itens[idx].preco;
      itens.splice(idx, 1);
      atualizarTudo();
    }

    function salvar() {
      localStorage.setItem('limitCalc', JSON.stringify({ limite, total, itens }));
    }

    // Teclado
    function abrirTeclado(msg = '') {
      valorCentavos = 0;
      atualizarDisplay();
      document.getElementById('nomeProduto').value = '';
      if (msg) {
        document.getElementById('msgErro').innerHTML = msg;
        document.getElementById('msgErro').style.display = 'block';
      } else {
        document.getElementById('msgErro').style.display = 'none';
      }
      document.getElementById('tecladoModal').style.display = 'flex';
      setTimeout(() => document.getElementById('nomeProduto').focus(), 300);
    }

    function fecharTeclado() {
      document.getElementById('tecladoModal').style.display = 'none';
    }

    function digito(n) {
      if (valorCentavos < 1000000) valorCentavos = valorCentavos * 10 + n;
      atualizarDisplay();
    }

    function apagar() {
      valorCentavos = Math.floor(valorCentavos / 10);
      atualizarDisplay();
    }

    function atualizarDisplay() {
      const reais = Math.floor(valorCentavos / 100).toLocaleString('pt-BR');
      const centavos = (valorCentavos % 100).toString().padStart(2, '0');
      document.getElementById('reais').innerText = reais;
      document.getElementById('centavos').innerText = centavos;
    }

    function confirmar() {
      const preco = valorCentavos / 100;
      if (preco <= 0) return alert('Digite um valor!');
      adicionar('', preco);
    }

    // Captura de Etiqueta
    function iniciarCaptura() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        const imgUrl = URL.createObjectURL(file);
        const worker = await Tesseract.createWorker();
        await worker.load();
        await worker.loadLanguage('por');
        await worker.initialize('por');
        const { data: { text } } = await worker.recognize(imgUrl);
        await worker.terminate();
        URL.revokeObjectURL(imgUrl);
        const texto = text.toLowerCase();
        const preco = extrairPreco(texto);
        const nome = extrairNome(texto);
        if (preco) {
          if (confirm(`Encontrado:\n${nome}\nR$ ${preco.toFixed(2).replace('.', ',')}\n\nAdicionar?`)) {
            adicionar(nome, preco);
          }
        } else {
          abrirTeclado('N√£o foi poss√≠vel ler a etiqueta. Digite manualmente:');
        }
      };
      input.click();
    }

    function extrairPreco(texto) {
      const regex = /r\$\s*(\d{1,5}[.,]\d{2})/i;
      const match = texto.match(regex);
      if (match) {
        return parseFloat(match[1].replace(',', '.'));
      }
      return null;
    }

    function extrairNome(texto) {
      const linhas = texto.split('\n').map(l => l.trim()).filter(l => l.length > 3);
      return linhas[0] || 'Produto';
    }

    // Modal Lista
    function abrirListaModal() {
      document.getElementById('dataAtual').innerText = new Date().toLocaleString('pt-BR');
      document.getElementById('totalModal').innerText = `TOTAL: R$ ${total.toFixed(2).replace('.', ',')}`;
      document.getElementById('listaModalItens').innerHTML = itens.map(i => 
        `<div class="lista-item">${i.nome}<br>R$ ${i.preco.toFixed(2).replace('.', ',')}</div>`
      ).join('') || '<p>Nenhum item</p>';
      document.getElementById('listaModal').style.display = 'flex';
    }

    function fecharListaModal() {
      document.getElementById('listaModal').style.display = 'none';
    }

    function baixarPDF() {
      const doc = {
        pageSize: 'A6', pageMargins: [15, 20, 15, 20],
        content: [
          { text: 'üõí LimitCalc', style: 'header' },
          { text: 'Lista de Produtos', style: 'subheader' },
          { canvas: [{ type: 'line', x1: 0, y1: 10, x2: 380, y2: 10, lineWidth: 2, lineColor: '#00bd56' }] },
          { text: '\n' },
          {
            layout: 'lightHorizontalLines',
            table: {
              headerRows: 1,
              widths: ['*', 'auto'],
              body: [
                [{ text: 'Produto', style: 'tableHeader' }, { text: 'Valor', style: 'tableHeader' }],
                ...itens.map(i => [i.nome, { text: `R$ ${i.preco.toFixed(2).replace('.', ',')}`, alignment: 'right' }]),
                [{ text: 'TOTAL GERAL', bold: true, colSpan: 1 }, { text: `R$ ${total.toFixed(2).replace('.', ',')}`, bold: true, alignment: 'right', fillColor: '#d4edda' }]
              ]
            }
          },
          { text: '\n' },
          { text: 'Data: ' + new Date().toLocaleString('pt-BR'), style: 'footer' }
        ],
        styles: {
          header: { fontSize: 24, bold: true, alignment: 'center', color: '#00bd56' },
          subheader: { fontSize: 18, bold: true, alignment: 'center' },
          tableHeader: { bold: true, fillColor: '#00bd56', color: 'white' },
          footer: { fontSize: 12, alignment: 'center', color: '#666' }
        }
      };
      pdfMake.createPdf(doc).download(`LimitCalc_${new Date().toLocaleDateString('pt-BR')}.pdf`);
    }

    function compartilharWhats() {
      baixarPDF(); // Para simplicidade, baixa o PDF e deixa o usu√°rio compartilhar
      alert('PDF baixado! Compartilhe pelo app de arquivos ou WhatsApp.');
    }

    // Fechar modais
    document.getElementById('tecladoModal').addEventListener('click', e => {
      if (e.target === document.getElementById('tecladoModal')) fecharTeclado();
    });
    document.getElementById('listaModal').addEventListener('click', e => {
      if (e.target === document.getElementById('listaModal')) fecharListaModal();
    });
  </script>
</body>
</html>
