<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;color:#333}
    .container{max-width:500px;margin:0 auto;background:white;min-height:100vh;padding-bottom:20px}
    header{background:#00bd56;color:white;text-align:center;padding:30px;font-size:40px;font-weight:bold}
    header span{font-size:60px;color:#000}
    #circle{width:320px;height:320px;margin:40px auto;border-radius:50%;border:28px solid #4CAF50;position:relative;background:#fff;box-shadow:0 0 25px rgba(0,0,0,.15)}
    #progress{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;font-weight:bold;color:#00bd56}
    .btn{padding:18px 32px;margin:15px;font-size:22px;border:none;border-radius:15px;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,.2);width:90%;max-width:400px}
    .btn-primary{background:#00bd56;color:white}
    .btn-capture{background:#007bff;color:white}
    .item{padding:18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-size:20px}
    .delete{color:red;font-size:28px;cursor:pointer}
    #limitDiv{text-align:center;padding:20px}
    #limitDiv input{padding:15px;font-size:24px;width:200px;border-radius:12px;border:2px solid #ddd;margin:10px}
    #botoesFinais{display:none;justify-content:center;gap:30px;margin:30px}
  </style>
  <!-- Tesseract leve que NUNCA estoura memória -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <header>LimitCalc <span>Cart</span></header>
    <div id="limitDiv">
      <input type="number" id="limite" placeholder="Seu limite R$" step="0.01">
      <button class="btn btn-primary" onclick="definirLimite()">Definir Limite</button>
    </div>
    <div id="circle"><div id="progress">R$ 0,00</div></div>
    <div style="text-align:center">
      <button class="btn btn-capture" onclick="iniciarCaptura()">Capturar Etiqueta</button>
      <button class="btn btn-primary" onclick="abrirTeclado()">Adicionar Manual</button>
    </div>
    <div id="listaItens" style="margin:20px;"></div>
    <div id="botoesFinais">
      <button class="btn btn-primary" onclick="alert('Lista salva no celular!')">Ver Lista Salva</button>
    </div>
  </div>

  <script>
    let limite=0,total=0,itens=[];
    if(localStorage.limitCalc){const d=JSON.parse(localStorage.limitCalc);limite=d.limite||0;total=d.total||0;itens=d.itens||[];atualizarTudo()}

    function definirLimite(){limite=parseFloat(document.getElementById('limite').value)||0;salvar();atualizarTudo()}
    function atualizarTudo(){
      document.getElementById('progress').innerText=`R$ ${total.toFixed(2).replace('.',',')}`;
      const perc=limite>0?total/limite*100:0;
      let cor='#4CAF50'; if(perc>=95)cor='#f44336'; else if(perc>=50)cor='#ff9800';
      document.querySelector('#circle').style.borderColor=cor;
      document.getElementById('botoesFinais').style.display=itens.length>0?'flex':'none';
      renderLista(); salvar();
    }
    function renderLista(){
      document.getElementById('listaItens').innerHTML=itens.map((i,idx)=>`<div class="item"><span>${i.nome} - R$ ${i.preco.toFixed(2).replace('.',',')}</span><span class="delete" onclick="remover(${idx})">Excluir</span></div>`).join('');
    }
    function adicionar(nome,preco){
      if(preco<=0)return;
      itens.push({nome,preco}); total+=preco; atualizarTudo();
    }
    function remover(idx){total-=itens[idx].preco; itens.splice(idx,1); atualizarTudo();}
    function salvar(){localStorage.limitCalc=JSON.stringify({limite,total,itens})}

    function abrirTeclado(){
      const nome=prompt("Nome do produto:");
      if(!nome)return;
      const pStr=prompt("Preço (ex: 16,98):");
      const p=parseFloat(pStr.replace(',','.'));
      if(p>0)adicionar(nome,p);
    }

    // CAPTURA IMUNE A MEMÓRIA + ATACADO/VAREJO
    async function iniciarCaptura(){
      const input=document.createElement('input');
      input.type='file'; input.accept='image/*'; input.capture='environment';
      input.onchange=async e=>{
        const file=e.target.files[0]; if(!file)return;

        // COMPRESSÃO FORTE = NUNCA ESTOURA MEMÓRIA
        const img=new Image();
        img.onload=()=>{
          const canvas=document.createElement('canvas');
          const ctx=canvas.getContext('2d');
          canvas.width=600; canvas.height=600*(img.height/img.width);
          ctx.drawImage(img,0,0,canvas.width,canvas.height);
          const dataUrl=canvas.toDataURL('image/jpeg',0.5); // 50% qualidade

          // Loading leve
          const load=document.createElement('div');
          load.textContent='Lendo...'; load.style.cssText='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#00bd56;color:white;padding:20px 40px;border-radius:20px;font-size:22px;z-index:9999';
          document.body.appendChild(load);

          (async()=>{
            try{
              const worker=await Tesseract.createWorker();
              await worker.load();
              await worker.loadLanguage('por');
              await worker.initialize('por',Tesseract.OEM.LSTM_ONLY);
              await worker.setParameters({tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK});
              const {data:{text}}=await worker.recognize(dataUrl);
              await worker.terminate();
              document.body.removeChild(load);

              const linhas=text.toUpperCase().split('\n');
              const nome=linhas.find(l=>l.length>5 && !l.includes('R$') && !l.match(/\d{4}/)) || 'Produto';
              const precos=linhas.flatMap(l=>[...l.matchAll(/R?\s*\$\s*([\d.,]+)/g)].map(m=>parseFloat(m[1].replace('.','').replace(',','.')))).filter(n=>n>1&&n<5000);

              if(precos.length===0){
                abrirTeclado('Não leu preço. Digite manualmente:');
                return;
              }

              if(precos.length===1){
                if(confirm(`${nome}\nR$ ${precos[0].toFixed(2).replace('.',',')}\n\nAdicionar?`)){
                  adicionar(nome,precos[0]);
                }
              }else{
                const varejo=Math.max(...precos);
                const atacado=Math.min(...precos);
                const qtdMin=6; // padrão brasileiro
                const qtd=prompt(`Dois preços!\n\n${nome}\n• Varejo: R$ ${varejo.toFixed(2)}\n• Atacado: R$ ${atacado.toFixed(2)} (a partir de ${qtdMin})\n\nQuantas unidades?`,qtdMin);
                if(qtd===null)return;
                const quantidade=parseInt(qtd)||1;
                const precoFinal=quantidade>=qtdMin?atacado:varejo;
                if(confirm(`Adicionar ${quantidade}x ${nome} = R$ ${(quantidade*precoFinal).toFixed(2)}?`)){
                  adicionar(`${nome} (${quantidade}x)`, quantidade*precoFinal);
                }
              }
            }catch(err){
              document.body.removeChild(load);
              abrirTeclado('Erro de leitura. Digite manualmente:');
            }
          })();
        };
        img.src=URL.createObjectURL(file);
      };
      input.click();
    }
  </script>
</body>
</html>
