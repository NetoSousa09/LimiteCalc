<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc - Sousa Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    /* MANTIVE SEU CSS, SÓ ADICIONEI TRATAMENTO DE ERRO VISUAL */
    body{font-family:Arial,sans-serif;background:#f4f4f4;margin:0;color:#333}
    .container{max-width:500px;margin:0 auto;background:white;min-height:100vh;padding-bottom:20px}
    header{background:#00bd56;color:white;text-align:center;padding:30px;font-size:40px;font-weight:bold}
    header span{font-size:60px;color:#000}
    #circle{width:320px;height:320px;margin:40px auto;border-radius:50%;border:28px solid #4CAF50;position:relative;background:#fff;box-shadow:0 0 25px rgba(0,0,0,.15);transition: border-color 0.5s}
    #progress{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:70px;font-weight:bold;color:#00bd56}
    .btn{padding:18px 32px;margin:15px;font-size:22px;border:none;border-radius:15px;cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,.2);width:90%;max-width:400px}
    .btn-primary{background:#00bd56;color:white}
    .btn-capture{background:#007bff;color:white}
    .item{padding:18px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;font-size:20px}
    .delete{color:red;font-size:28px;cursor:pointer}
    #limitDiv{text-align:center;padding:20px}
    #limitDiv input{padding:15px;font-size:24px;width:200px;border-radius:12px;border:2px solid #ddd;margin:10px}
    #statusOCR{text-align: center; font-weight: bold; color: #555; margin-top: 10px; display: none;}
    #botoesFinais{display:none;justify-content:center;gap:30px;margin:30px}
  </style>
</head>
<body>
  <div class="container">
    <header>LimitCalc <span>Cart</span></header>
    
    <div id="limitDiv">
      <input type="number" id="limiteInput" placeholder="Seu limite R$" step="0.01">
      <button class="btn btn-primary" onclick="definirLimite()">Definir Limite</button>
    </div>

    <div id="circle"><div id="progress">R$ 0,00</div></div>
    
    <div style="text-align:center">
      <!-- Input file invisível para melhor controle -->
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processarImagem(this)">
      
      <button class="btn btn-capture" id="btnCam" onclick="document.getElementById('cameraInput').click()">Capturar Etiqueta</button>
      <div id="statusOCR">Carregando IA...</div>
      <button class="btn btn-primary" onclick="abrirTeclado()">Adicionar Manual</button>
    </div>

    <div id="listaItens" style="margin:20px;"></div>
    
    <div id="botoesFinais">
      <button class="btn btn-primary" onclick="alert('Lista salva no celular!')">Ver Lista Salva</button>
    </div>
  </div>

  <script>
    // ESTADO
    let estado = { limite: 0, total: 0, itens: [] };
    let worker = null; // Worker global para reuso

    // INICIALIZAÇÃO SEGURA
    window.onload = async () => {
      carregarDados();
      prepararOCR();
    };

    function carregarDados() {
      try {
        if (localStorage.limitCalc) {
          const d = JSON.parse(localStorage.limitCalc);
          estado.limite = d.limite || 0;
          estado.total = d.total || 0;
          estado.itens = d.itens || [];
          document.getElementById('limiteInput').value = estado.limite || '';
          atualizarInterface();
        }
      } catch (e) {
        console.error("Erro ao carregar dados", e);
        localStorage.removeItem('limitCalc'); // Reseta se estiver corrompido
      }
    }

    function salvar() {
      localStorage.limitCalc = JSON.stringify(estado);
    }

    function definirLimite() {
      const val = parseFloat(document.getElementById('limiteInput').value);
      if (!isNaN(val)) {
        estado.limite = val;
        salvar();
        atualizarInterface();
      }
    }

    function atualizarInterface() {
      document.getElementById('progress').innerText = `R$ ${estado.total.toFixed(2).replace('.', ',')}`;
      
      const perc = estado.limite > 0 ? (estado.total / estado.limite) * 100 : 0;
      let cor = '#4CAF50';
      if (perc >= 100) cor = '#000000'; // Estourou fica preto ou roxo
      else if (perc >= 90) cor = '#f44336';
      else if (perc >= 60) cor = '#ff9800';
      
      document.getElementById('circle').style.borderColor = cor;
      
      const lista = document.getElementById('listaItens');
      lista.innerHTML = estado.itens.map((i, idx) => 
        `<div class="item">
            <span>${i.nome} <small>(${i.qtd || 1}x)</small> <br> <b>R$ ${i.preco.toFixed(2).replace('.',',')}</b></span>
            <span class="delete" onclick="remover(${idx})">Excluir</span>
         </div>`
      ).join('');
      
      document.getElementById('botoesFinais').style.display = estado.itens.length > 0 ? 'flex' : 'none';
    }

    function adicionar(nome, preco, qtd = 1) {
      estado.itens.push({ nome, preco, qtd });
      estado.total += preco;
      salvar();
      atualizarInterface();
    }

    function remover(idx) {
      estado.total -= estado.itens[idx].preco;
      estado.itens.splice(idx, 1);
      salvar();
      atualizarInterface();
    }

    function abrirTeclado(msg = null) {
      const nome = prompt(msg || "Nome do produto:");
      if (!nome) return;
      
      let pStr = prompt("Preço unitário (ex: 16,98):");
      if (!pStr) return;
      
      // Tratamento melhorado de input manual
      pStr = pStr.replace(',', '.');
      const preco = parseFloat(pStr);
      
      if (preco > 0) adicionar(nome, preco);
      else alert("Preço inválido!");
    }

    // --- OCR OTIMIZADO ---

    async function prepararOCR() {
      const status = document.getElementById('statusOCR');
      const btn = document.getElementById('btnCam');
      status.style.display = 'block';
      status.innerText = 'Iniciando Motor de IA...';
      btn.disabled = true;

      try {
        worker = await Tesseract.createWorker();
        await worker.loadLanguage('por');
        await worker.initialize('por');
        await worker.setParameters({
            tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz$.,% ', // Foca em preços e texto
        });
        status.style.display = 'none';
        btn.disabled = false;
        console.log("OCR Pronto");
      } catch (err) {
        status.innerText = 'Erro ao carregar IA. Use manual.';
        console.error(err);
      }
    }

    async function processarImagem(input) {
      const file = input.files[0];
      if (!file || !worker) return;

      const load = document.createElement('div');
      load.textContent = 'Lendo Etiqueta...';
      load.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#00bd56;color:white;padding:30px;border-radius:20px;font-size:24px;z-index:9999;box-shadow:0 0 100px rgba(0,0,0,0.5)';
      document.body.appendChild(load);

      try {
        // Tesseract lê direto do arquivo (resolve rotação melhor que canvas manual)
        const { data: { text } } = await worker.recognize(file);
        
        document.body.removeChild(load);
        analisarTexto(text);
        
      } catch (err) {
        document.body.removeChild(load);
        alert("Erro na leitura. Tente focar melhor.");
      }
      input.value = ''; // Limpa para permitir selecionar mesma foto se quiser
    }

    function analisarTexto(text) {
      console.log("Texto lido:", text); // Para debug
      const linhas = text.toUpperCase().split('\n');
      
      // Regex melhorada: Aceita "R$ 10,00", "10.00", "10,00" mas evita datas como 2024
      // Captura números que parecem dinheiro
      const regexPreco = /R?\s*\$?\s*(\d{1,3}(?:[.,]\d{3})*[.,]\d{2})/g;
      
      let precosEncontrados = [];
      
      // Varredura no texto completo
      let match;
      while ((match = regexPreco.exec(text)) !== null) {
          // Limpa o valor achado para formato JS (ponto decimal, sem milhar)
          let valorLimpo = match[1];
          
          // Se tem vírgula no final (padrão BR 10,90), substitui por ponto
          if (valorLimpo.includes(',') && !valorLimpo.includes('.')) {
             valorLimpo = valorLimpo.replace(',', '.');
          } 
          // Se tem ponto e vírgula (1.000,00), remove ponto e troca vírgula
          else if (valorLimpo.includes('.') && valorLimpo.includes(',')) {
             valorLimpo = valorLimpo.replace('.', '').replace(',', '.');
          }
          
          const floatVal = parseFloat(valorLimpo);
          if (floatVal > 0.05 && floatVal < 10000) { // Filtro de ruído
             precosEncontrados.push(floatVal);
          }
      }

      if (precosEncontrados.length === 0) {
        abrirTeclado('Preço não identificado. Digite:');
        return;
      }

      // Lógica Simplificada: Pega o maior valor (geralmente o preço principal em destaque)
      // Ou se tiver 2 valores próximos, oferece escolha.
      const nomeProvavel = linhas.find(l => l.length > 4 && !l.match(/\d/)) || "Produto";
      
      // Remove duplicatas
      precosEncontrados = [...new Set(precosEncontrados)].sort((a,b) => b-a);

      if (precosEncontrados.length === 1) {
         if(confirm(`Adicionar ${nomeProvavel} por R$ ${precosEncontrados[0].toFixed(2)}?`)) {
            adicionar(nomeProvavel, precosEncontrados[0]);
         }
      } else {
         // Pega o maior (Varejo costuma ser maior que atacado, ou destaque é maior)
         const maior = precosEncontrados[0];
         const menor = precosEncontrados[precosEncontrados.length-1];
         
         const op = prompt(`Detectamos preços:\nA: R$ ${maior.toFixed(2)}\nB: R$ ${menor.toFixed(2)}\n\nDigite A ou B, ou valor manual:`);
         if(op?.toUpperCase() === 'A') adicionar(nomeProvavel, maior);
         else if(op?.toUpperCase() === 'B') adicionar(nomeProvavel, menor);
         else if(op) {
            const manual = parseFloat(op.replace(',','.'));
            if(manual) adicionar(nomeProvavel, manual);
         }
      }
    }
  </script>
</body>
</html>
