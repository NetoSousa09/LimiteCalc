<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc Leve</title>
  
  <!-- Tesseract (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { --primary: #00bd56; --danger: #f44336; --dark: #333; }
    body { font-family: sans-serif; background: #f8f9fa; margin: 0; padding-bottom: 80px; touch-action: manipulation; }
    
    header { background: var(--primary); color: white; text-align: center; padding: 15px; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 24px; }

    .container { max-width: 600px; margin: 0 auto; padding: 15px; text-align: center; }

    /* Input Limite */
    .limit-box { background: white; padding: 10px; border-radius: 15px; margin-top: -25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: inline-flex; gap: 10px; align-items: center; }
    input[type="number"] { padding: 8px; border: 2px solid #eee; border-radius: 8px; font-size: 18px; width: 100px; text-align: center; }

    /* C√≠rculo */
    #circle { width: 220px; height: 220px; margin: 20px auto; border-radius: 50%; border: 15px solid #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; }
    #progress-text { font-size: 36px; font-weight: bold; color: var(--dark); }

    /* Bot√µes Grandes */
    .btn { padding: 15px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; width: 100%; margin-bottom: 10px; color: white; font-weight: bold; }
    .btn-cam { background: #007bff; }
    .btn-add { background: white; border: 2px solid var(--primary); color: var(--primary); }
    .btn-list { background: var(--dark); }

    /* Modal */
    #modalLista { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; flex-direction: column; }
    .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { flex: 1; overflow-y: auto; padding: 10px; }
    .item-card { background: #fff; border-bottom: 1px solid #ddd; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    
    /* Loading */
    #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; color: white; flex-direction: column; justify-content: center; align-items: center; }
  </style>
</head>
<body>

  <header>
    <h1>LimitCalc <span>Lite</span></h1>
  </header>

  <div class="container">
    <div class="limit-box">
      <span>Meta: R$</span>
      <input type="number" id="limiteInput" placeholder="0" onblur="definirLimite()">
    </div>

    <div id="circle">
      <div id="progress-text">R$ 0,00</div>
      <small>Gasto Total</small>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="processarImagem(this)">
    
    <button class="btn btn-cam" onclick="document.getElementById('cameraInput').click()">üì∑ Capturar Pre√ßo</button>
    <button class="btn btn-add" onclick="adicionarManual()">‚å®Ô∏è Digitar Manual</button>
    <button class="btn btn-list" onclick="abrirLista()">üìÑ Ver Lista</button>
  </div>

  <!-- Modal Lista -->
  <div id="modalLista">
    <div class="modal-header">
      <h3>Minha Lista</h3>
      <button onclick="fecharLista()" style="font-size:20px;border:none;background:none">‚úï</button>
    </div>
    <div style="padding:10px; display:flex; gap:10px">
      <button class="btn" style="background:#25D366; margin:0" onclick="zap()">WhatsApp</button>
      <button class="btn" style="background:#E91E63; margin:0" onclick="pdf()">PDF</button>
    </div>
    <div class="modal-body" id="listaBody"></div>
  </div>

  <!-- Loading -->
  <div id="loadingOverlay">
    <h2>Lendo...</h2>
    <p>Aguarde um momento</p>
  </div>

  <script>
    // --- SETUP LEVE ---
    let estado = { limite: 0, total: 0, itens: [] };
    let worker = null;

    window.onload = async () => {
      if(localStorage.limitCalcLite) estado = JSON.parse(localStorage.limitCalcLite);
      document.getElementById('limiteInput').value = estado.limite || '';
      atualizarInterface();
      
      // Inicializa OCR silenciosamente
      try {
        worker = await Tesseract.createWorker();
        await worker.loadLanguage('por');
        await worker.initialize('por');
        await worker.setParameters({
          tessedit_char_whitelist: '0123456789$,.% ' // S√≥ permite n√∫meros e s√≠mbolos de pre√ßo
        });
        console.log("OCR Carregado");
      } catch(e) { console.error(e); }
    };

    function salvar() {
      localStorage.limitCalcLite = JSON.stringify(estado);
      atualizarInterface();
    }

    function definirLimite() {
      estado.limite = parseFloat(document.getElementById('limiteInput').value) || 0;
      salvar();
    }

    // --- L√ìGICA OCR OTIMIZADA (SEM ESTOURAR MEM√ìRIA) ---
    async function processarImagem(input) {
      const file = input.files[0];
      if(!file) return;

      document.getElementById('loadingOverlay').style.display = 'flex';

      try {
        // 1. Redimensionar imagem para max 600px (Isso salva a mem√≥ria RAM)
        const imagemPequena = await redimensionarImagem(file);

        // 2. Ler direto (sem processamento pesado de pixels)
        if(!worker) { alert("IA ainda carregando..."); return; }
        
        const { data: { text } } = await worker.recognize(imagemPequena);
        
        interpretarTexto(text);

      } catch (err) {
        alert("Erro de mem√≥ria ou leitura. Tente uma foto mais de perto.");
        console.error(err);
      } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
        input.value = ''; // Limpa input
      }
    }

    function redimensionarImagem(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // For√ßa largura m√°xima de 600px (O segredo para n√£o travar)
          const MAX_WIDTH = 600;
          const scale = Math.min(MAX_WIDTH / img.width, 1);
          
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          // Retorna o canvas direto (mais leve que toDataURL)
          resolve(canvas);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function interpretarTexto(text) {
      // Procura pre√ßos no texto bagun√ßado
      const regex = /(?:R\$)?\s*(\d{1,3}(?:[.,]\d{3})*[.,]\d{2})/g;
      let match;
      let precos = [];

      while ((match = regex.exec(text)) !== null) {
        // Corrige v√≠rgula/ponto
        let valStr = match[1];
        if(valStr.includes(',') && !valStr.includes('.')) valStr = valStr.replace(',','.');
        else if(valStr.includes('.') && valStr.includes(',')) valStr = valStr.replace('.','').replace(',','.');
        
        const val = parseFloat(valStr);
        if(val > 0 && val < 10000) precos.push(val);
      }

      if(precos.length > 0) {
        const maiorPreco = Math.max(...precos); // Pega o maior (geralmente o correto)
        if(confirm(`Pre√ßo identificado: R$ ${maiorPreco.toFixed(2)}\nAdicionar √† lista?`)) {
          adicionarItem("Produto " + (estado.itens.length + 1), maiorPreco);
        }
      } else {
        alert("N√£o consegui ler o pre√ßo. Tente digitar.");
      }
    }

    // --- CRUD B√ÅSICO ---
    function adicionarItem(nome, preco) {
      estado.itens.push({ nome, preco });
      estado.total += preco;
      salvar();
    }

    function adicionarManual() {
      const nome = prompt("Nome:") || "Item";
      const preco = parseFloat((prompt("Valor:")||"").replace(',','.'));
      if(preco) adicionarItem(nome, preco);
    }

    function remover(i) {
      if(confirm("Excluir item?")) {
        estado.total -= estado.itens[i].preco;
        estado.itens.splice(i,1);
        salvar();
        renderLista();
      }
    }

    function atualizarInterface() {
      document.getElementById('progress-text').innerText = `R$ ${estado.total.toFixed(2).replace('.',',')}`;
      const circ = document.getElementById('circle');
      if(estado.limite > 0) {
        const perc = (estado.total / estado.limite) * 100;
        circ.style.borderColor = perc > 90 ? '#f44336' : (perc > 50 ? '#FF9800' : '#4CAF50');
      }
    }

    // --- MODAL ---
    function abrirLista() { renderLista(); document.getElementById('modalLista').style.display = 'flex'; }
    function fecharLista() { document.getElementById('modalLista').style.display = 'none'; }
    
    function renderLista() {
      const div = document.getElementById('listaBody');
      div.innerHTML = estado.itens.map((item, i) => `
        <div class="item-card">
          <span>${item.nome}</span>
          <div style="display:flex;align-items:center;gap:10px">
            <b>R$ ${item.preco.toFixed(2).replace('.',',')}</b>
            <button onclick="remover(${i})" style="color:red;border:none;background:none;font-size:20px">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    // --- EXPORTAR ---
    function zap() {
      let msg = "*Minha Lista:*\n";
      estado.itens.forEach(i => msg += `- ${i.nome}: R$ ${i.preco.toFixed(2)}\n`);
      msg += `\n*Total: R$ ${estado.total.toFixed(2)}*`;
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    }

    function pdf() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Lista de Compras", 20, 20);
      doc.autoTable({
        head: [['Item', 'Valor']],
        body: estado.itens.map(i => [i.nome, `R$ ${i.preco.toFixed(2)}`])
      });
      doc.text(`Total: R$ ${estado.total.toFixed(2)}`, 20, doc.lastAutoTable.finalY + 10);
      doc.save('lista.pdf');
    }
  </script>
</body>
</html>
