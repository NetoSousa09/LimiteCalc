<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LimitCalc</title>
  <meta name="description" content="Controle seu orçamento no supermercado com OCR de etiqueta e teclado brasileiro!">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-512.png" type="image/png">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; color:#333; }
    .container { max-width: 500px; margin: 0 auto; background: white; min-height: 100vh; }
    header { background: #00bd56; color: white; text-align: center; padding: 20px; }
    #circle { width: 300px; height: 300px; margin: 30px auto; border-radius: 50%; border: 20px solid #ddd; position: relative; }
    #progress { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 60px; font-weight: bold; }
    #limitInput { text-align: center; font-size: 24px; margin: 20px; }
    .btn { padding: 15px; font-size: 18px; margin: 10px; border: none; border-radius: 12px; cursor: pointer; }
    .btn-primary { background: #00bd56; color: white; }
    .btn-capture { background: #007bff; color: white; }
    .btn-whatsapp { background: #25D366; color: white; }
    .item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    .delete { color: red; cursor: pointer; }
    #tecladoModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 999; }
    .teclado-container { background: white; border-radius: 20px; padding: 20px; width: 90%; max-width: 400px; text-align: center; }
    .display-preco { font-size: 48px; font-weight: bold; margin: 20px 0; color: #00bd56; }
    .teclado { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; }
    .teclado button { font-size: 32px; padding: 20px; border-radius: 15px; background: #f0f0f0; border: none; }
    .teclado .ok { background: #00bd56; color: white; grid-column: span 3; }
    .teclado .apagar { background: #ff4444; color: white; }
    #msgErro { background: #fff3cd; color: #856404; padding: 12px; border-radius: 10px; margin-bottom: 15px; }
    #botoesFinais { display: none; justify-content: center; gap: 20px; margin: 20px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.12/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1> LimitCalc</h1></header>
    <div id="limitInput">
      <input type="number" id="limite" placeholder="Digite seu limite (R$)" step="0.01">
      <button class="btn btn-primary" onclick="definirLimite()">Definir Limite</button>
    </div>
    <div id="circle"><div id="progress">R$ 0,00</div></div>
    <div style="text-align:center">
      <button class="btn btn-capture" onclick="iniciarCaptura()"> Capturar Etiqueta</button>
      <button class="btn btn-primary" onclick="abrirTeclado()"> Adicionar Manual</button>
    </div>
    <div id="listaItens"></div>
    <div id="botoesFinais">
      <button class="btn btn-primary" onclick="gerarPDF().then(r => r.download())"> Baixar PDF</button>
      <button class="btn btn-whatsapp" onclick="compartilharWhats()"> WhatsApp</button>
    </div>
  </div>

  <!-- Modal Teclado -->
  <div id="tecladoModal">
    <div class="teclado-container">
      <div id="msgErro" style="display:none"></div>
      <div class="display-preco">R$ <span id="reais">0</span>,<span id="centavos">00</span></div>
      <div class="teclado">
        <button onclick="digito(1)">1</button><button onclick="digito(2)">2</button><button onclick="digito(3)">3</button>
        <button onclick="digito(4)">4</button><button onclick="digito(5)">5</button><button onclick="digito(6)">6</button>
        <button onclick="digito(7)">7</button><button onclick="digito(8)">8</button><button onclick="digito(9)">9</button>
        <button onclick="apagar()" class="apagar">←</button><button onclick="digito(0)">0</button>
        <button onclick="adicionarItem()" class="ok"> ADICIONAR</button>
      </div>
      <input type="text" id="nomeProduto" placeholder="Nome do produto (opcional)" style="width:100%; padding:12px; margin-top:20px; font-size:18px; border-radius:12px; border:2px solid #ddd;">
    </div>
  </div>

  <script>
    let limite = 0, total = 0, itens = [], valorCentavos = 0;
    if (localStorage.limitCalc) {
      const data = JSON.parse(localStorage.limitCalc);
      limite = data.limite; total = data.total; itens = data.itens;
      atualizarTudo();
    }

    function definirLimite() {
      limite = parseFloat(document.getElementById('limite').value) || 0;
      salvar(); atualizarTudo();
    }

    function atualizarTudo() {
      document.getElementById('progress').innerText = R$ ${total.toFixed(2).replace('.',',')};
      const perc = limite ? total/limite * 100 : 0;
      let cor = '#4CAF50';
      if (perc > 90) cor = '#f44336';
      else if (perc > 70) cor = '#ff9800';
      document.querySelector('#circle').style.borderColor = cor;
      document.getElementById('botoesFinais').style.display = itens.length ? 'flex' : 'none';
      renderLista();
      salvar();
    }

    function renderLista() {
      const lista = document.getElementById('listaItens');
      lista.innerHTML = itens.map((i,idx) => `
        <div class="item">
          <span>${i.nome} - R$ ${i.preco.toFixed(2).replace('.',',')}</span>
          <span class="delete" onclick="remover(${idx})"></span>
        </div>`).join('');
    }

    function adicionarItem(nome = '', preco = 0) {
      if (preco <= 0) return;
      nome = nome || document.getElementById('nomeProduto').value.trim() || Item R$ ${preco.toFixed(2)};
      itens.push({nome, preco});
      total += preco;
      fecharTeclado();
      atualizarTudo();
    }

    function remover(idx) {
      total -= itens[idx].preco;
      itens.splice(idx,1);
      atualizarTudo();
    }

    function salvar() {
      localStorage.limitCalc = JSON.stringify({limite, total, itens});
    }

    // Teclado
    function abrirTeclado(msg = '') {
      valorCentavos = 0;
      atualizarDisplay();
      document.getElementById('nomeProduto').value = '';
      if (msg) document.getElementById('msgErro').innerHTML = msg; document.getElementById('msgErro').style.display = msg ? 'block' : 'none';
      document.getElementById('tecladoModal').style.display = 'flex';
      document.getElementById('nomeProduto').focus();
    }

    function fecharTeclado() {
      document.getElementById('tecladoModal').style.display = 'none';
    }

    function digito(n) {
      if (valorCentavos < 1000000) {
        valorCentavos = valorCentavos * 10 + n;
        atualizarDisplay();
      }
    }

    function apagar() {
      valorCentavos = Math.floor(valorCentavos / 10);
      atualizarDisplay();
    }

    function atualizarDisplay() {
      const reais = Math.floor(valorCentavos / 100).toLocaleString('pt-BR');
      const centavos = (valorCentavos % 100).toString().padStart(2,'0');
      document.getElementById('reais').innerText = reais;
      document.getElementById('centavos').innerText = centavos;
    }

    function iniciarCaptura() {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
      input.onchange = async e => {
        const file = e.target.files[0];
        const imgUrl = URL.createObjectURL(file);
        const result = await Tesseract.recognize(imgUrl, 'por', { logger: m => console.log(m) });
        const texto = result.data.text;
        const preco = extrairPreco(texto);
        const nome = extrairNome(texto);
        URL.revokeObjectURL(imgUrl);
        if (preco) {
          if (confirm(Encontrado:\n${nome}\nR$ ${preco.toFixed(2)}\nAdicionar?)) {
            adicionarItem(nome, preco);
          }
        } else {
          abrirTeclado(' Não foi possível ler a etiqueta<br>Digite manualmente:');
        }
      };
      input.click();
    }

    function extrairPreco(txt) {
      const match = txt.match(/(\d{1,5}[.,]\d{2})/g);
      if (!match) return null;
      return match.map(v => parseFloat(v.replace(',','.'))).sort((a,b)=>b-a)[0];
    }

    function extrairNome(txt) {
      const linhas = txt.split('\n').map(l=>l.trim()).filter(l=>l.length>2 && !/\d[.,]\d/.test(l));
      return linhas[0] || 'Produto';
    }

    // PDF e WhatsApp
    function gerarPDF() {
      const doc = {
        pageSize: 'A6', pageMargins: [15,20,15,20],
        content: [
          {text: ' LIMITCALC', style: 'header'},
          {text: new Date().toLocaleString('pt-BR'), style: 'sub'},
          {table: {widths: ['*','auto'], body: [
            [{text:'Produto',bold:true},{text:'Valor',bold:true}],
            ...itens.map(i=>[i.nome,R$ ${i.preco.toFixed(2).replace('.',',')}]),
            [{text:'TOTAL',bold:true},{text:R$ ${total.toFixed(2).replace('.',',')},bold:true}]
          ]}},
          total > limite ? {text: Estourou R$ ${(total-limite).toFixed(2)}, style:'alerta'} : {text:' Dentro do orçamento!', style:'ok'}
        ],
        styles: {header:{fontSize:24,bold:true,alignment:'center',color:'#00bd56'}, sub:{fontSize:12,alignment:'center'}, ok:{color:'green',alignment:'center'}, alerta:{color:'red',alignment:'center'}}
      };
      return pdfMake.createPdf(doc);
    }

    async function compartilharWhats() {
      const pdf = gerarPDF();
      pdf.getBlob(async blob => {
        const file = new File([blob], "LimitCalc.pdf", {type: 'application/pdf'});
        if (navigator.share) {
          await navigator.share({files: [file], title: 'Minha compra no LimitCalc', text: 'Olha minha compra de hoje!'});
        } else {
          alert('Compartilhamento não suportado - baixe o PDF');
        }
      });
    }

    // Fechar modal clicando fora
    document.getElementById('tecladoModal').onclick = e => { if(e.target === document.getElementById('tecladoModal')) fecharTeclado(); };
  </script>
</body>
</html>
